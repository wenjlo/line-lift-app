<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID è³‡è¨ŠæŸ¥è©¢</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 20px; text-align: center; background: #f0f0f0; }
        .box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .label { font-size: 12px; color: #888; margin-bottom: 5px; margin-top: 15px;}
        .val { font-family: monospace; font-size: 16px; font-weight: bold; word-break: break-all; margin-bottom: 5px; }

        /* ID ç‹€æ…‹æ¨£å¼ */
        .u-id { color: #007bff; background: #e3f2fd; padding: 8px; border-radius: 5px; border: 1px solid #007bff; display:block; }
        .c-id { color: #00B900; border: 1px solid #00B900; background: #e8f5e9; padding: 8px; border-radius: 5px; display:block;}
        .uuid { color: #d32f2f; border: 1px dashed #d32f2f; background: #ffebee; padding: 8px; border-radius: 5px; display:block;}

        /* æŒ‰éˆ•æ¨£å¼ */
        button { border-radius: 50px; border: none; font-size: 14px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.2s; }
        .btn-green { background: #06C755; color: white; padding: 12px 24px; }
        .btn-blue { background: #007bff; color: white; padding: 12px 24px; }
        .btn-gray { background: #666; color: white; padding: 12px 24px; }

        /* æ–°å¢ï¼šè¤‡è£½å°æŒ‰éˆ• */
        .btn-copy {
            background: #eee; color: #333;
            padding: 6px 15px;
            font-size: 12px;
            width: auto; /* ä¸è¦åœ¨å¯¬åº¦ä¸Šæ’æ»¿ */
            border: 1px solid #ccc;
            margin-top: 5px;
            display: inline-block;
        }
        .btn-copy:active { background: #ddd; transform: scale(0.95); }

        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
    </style>
</head>
<body>

    <div id="loading">è®€å–ä¸­...</div>

    <div class="box" id="result" style="display:none;">
        <h3>ğŸ•µï¸ ID è¨ºæ–·å ±å‘Š</h3>

        <div class="label">ğŸ‘¤ User ID (å€‹äºº ID)</div>
        <div id="display-user-id" class="val">Checking...</div>
        <button class="btn-copy" onclick="copyText(currentUserId)">ğŸ“‹ è¤‡è£½ User ID</button>

        <hr>

        <div class="label">ğŸ‘¥ Group ID (ç¾¤çµ„ ID/UUID)</div>
        <div id="context-id" class="val">Checking...</div>
        <button class="btn-copy" onclick="copyText(currentGroupId)">ğŸ“‹ è¤‡è£½ Group ID</button>

        <div id="status-text" style="font-size: 13px; margin-bottom: 15px; margin-top: 15px;"></div>

        <div id="success-area" style="display:none;">
            <p style="font-size:12px; color:#666;">æ­å–œï¼æ­¤ Group ID ç‚ºçœŸå¯¦ IDã€‚</p>
        </div>

        <div id="fail-area" style="display:none;">
            <p style="font-size:12px; color:#d32f2f; text-align: left;">
                <b>ç›®å‰é¡¯ç¤ºçš„æ˜¯è™›æ“¬ UUID</b><br>
                é€™ä»£è¡¨æ¬Šé™æˆ–å¥½å‹é—œä¿‚æœªé€šéã€‚è‹¥æ‚¨æ˜¯é–‹ç™¼è€…éœ€è¦çœŸå¯¦ IDï¼Œè«‹é»ä¸‹æ–¹æŒ‰éˆ•ã€‚
            </p>
            <button class="btn-blue" onclick="askBot()">ğŸ¤– å‘¼å«æ©Ÿå™¨äººæŸ¥ ID</button>
        </div>

        <button class="btn-gray" onclick="window.location.reload()" style="margin-top:20px;">ğŸ”„ é‡æ–°æ•´ç†</button>
    </div>

    <script>
        // å®šç¾©å…¨åŸŸè®Šæ•¸ï¼Œæ–¹ä¾¿è¤‡è£½åŠŸèƒ½å­˜å–
        let currentUserId = "";
        let currentGroupId = "";

        async function main() {
            try {
                // 1. è®€å–è¨­å®š
                const configRes = await fetch(`config.json?t=${new Date().getTime()}`);
                const config = await configRes.json();

                // 2. åˆå§‹åŒ–
                await liff.init({ liffId: config.userIDLiffId });

                if (!liff.isLoggedIn()) { liff.login(); return; }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('result').style.display = 'block';

                // --- 3. å–å¾— User ID ---
                const profile = await liff.getProfile();
                currentUserId = profile.userId; // å­˜å…¥è®Šæ•¸

                const userIdDiv = document.getElementById('display-user-id');
                userIdDiv.innerText = currentUserId;
                userIdDiv.classList.add("u-id");

                // --- 4. å–å¾— Context (Group ID) ---
                const context = liff.getContext();

                if (context && context.type === 'group') {
                    currentGroupId = context.groupId; // å­˜å…¥è®Šæ•¸

                    const displayEl = document.getElementById('context-id');
                    displayEl.innerText = currentGroupId;

                    if (currentGroupId.startsWith("C")) {
                        // æˆåŠŸ (çœŸå¯¦ ID)
                        displayEl.classList.add("c-id");
                        document.getElementById('status-text').innerHTML = "âœ… <b>çœŸå¯¦ Group ID</b>";
                        document.getElementById('status-text').style.color = "green";
                        document.getElementById('success-area').style.display = "block";
                    } else {
                        // å¤±æ•— (UUID)
                        displayEl.classList.add("uuid");
                        document.getElementById('status-text').innerHTML = "âŒ <b>è™›æ“¬ ID (UUID)</b>";
                        document.getElementById('status-text').style.color = "red";
                        document.getElementById('fail-area').style.display = "block";
                    }
                } else if (context && context.type === 'room') {
                    currentGroupId = context.roomId; // æ”¯æ´èŠå¤©å®¤
                    document.getElementById('context-id').innerText = currentGroupId;
                    document.getElementById('status-text').innerText = "èŠå¤©å®¤ (Room) ç’°å¢ƒ";
                    document.getElementById('context-id').classList.add("uuid"); // é€šå¸¸ä¹Ÿæ˜¯ UUID
                } else {
                    document.getElementById('context-id').innerText = "éç¾¤çµ„ç’°å¢ƒ";
                    document.getElementById('status-text').innerText = "è«‹åœ¨ç¾¤çµ„å…§é–‹å•Ÿä»¥å–å¾— Group ID";
                    // æ²’ ID æ™‚ï¼Œæ¸…ç©ºè®Šæ•¸é¿å…è¤‡è£½åˆ°éŒ¯èª¤å…§å®¹
                    currentGroupId = "";
                }

            } catch (err) {
                alert("éŒ¯èª¤ï¼š" + err);
                console.error(err);
            }
        }

        // --- å‘¼å«æ©Ÿå™¨äººæ•‘æ´ ---
        async function askBot() {
            if (!liff.isInClient()) {
                alert('è«‹åœ¨ LINE App å…§ä½¿ç”¨');
                return;
            }
            try {
                await liff.sendMessages([{ type: 'text', text: '#DEBUG_ID' }]);
                alert('æŒ‡ä»¤å·²ç™¼é€ï¼è«‹æŸ¥çœ‹èŠå¤©å®¤ä¸­æ©Ÿå™¨äººçš„å›è¦†ã€‚');
            } catch (error) {
                alert('ç™¼é€å¤±æ•—ï¼Œè«‹ç¢ºèªæ‚¨æœ‰ chat_message.write æ¬Šé™ã€‚');
            }
        }

        // --- è¤‡è£½æ–‡å­—åŠŸèƒ½ ---
        function copyText(text) {
            if (!text) {
                alert("ç›®å‰æ²’æœ‰ ID å¯ä¾›è¤‡è£½");
                return;
            }
            // ä½¿ç”¨ Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n" + text);
                }).catch(err => {
                    alert("è¤‡è£½å¤±æ•—: " + err);
                });
            } else {
                // å‚™ç”¨æ–¹æ¡ˆ (èˆŠç‰ˆç€è¦½å™¨)
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n" + text);
                } catch (err) {
                    alert("è¤‡è£½å¤±æ•—");
                }
                document.body.removeChild(textArea);
            }
        }

        main();
    </script>
</body>
</html>